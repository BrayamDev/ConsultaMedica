@using ConsultaMedica.Models.ViewModels
@model HistoriaClinicaViewModel

@{
    var paciente = ViewBag.Paciente as Pacientes;
    var citaId = ViewBag.CitaId;
    var medicoId = ViewBag.MedicoId;
    var medicos = ViewBag.Medicos as List<SelectListItem> ?? new List<SelectListItem>();

}

<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- En tu vista -->
    <title>@ViewBag.Title</title>
    <link rel="stylesheet" href="../bootstrap/css/bootstrap.min.css">
    <!-- Remix Icon CSS (para los iconos) -->
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
    <!-- JS for jQuery -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <!-- bootstrap css and js -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" />
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"></script>
    <!-- PNotify  -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pnotify/dist/PNotifyBrightTheme.css">
    <script src="https://cdn.jsdelivr.net/npm/pnotify/dist/iife/PNotify.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/pnotify/dist/iife/PNotifyButtons.js"></script>
    <!-- DataTables CSS -->
    <link rel="stylesheet" href="https://cdn.datatables.net/2.0.7/css/dataTables.dataTables.min.css">
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <!-- FullCalendar CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css">
    <!-- FullCalendar JS -->
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js"></script>
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css">
    <!-- jsPDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
</head>

<body>

    @if (TempData["Mensaje"] != null)
    {
        <script>
            PNotify.defaults.stack = {
                dir1: 'up',
                dir2: 'left',
                firstpos1: 25,
                firstpos2: 25,
                spacing1: 25,
                spacing2: 25,
                push: 'bottom',
                context: document.body
            };

            var tipoMensaje = "@TempData["TipoMensaje"]";
            var mensaje = "@Html.Raw(TempData["Mensaje"])";

            if (tipoMensaje === "success") {
                PNotify.success({
                    title: 'Éxito',
                    text: mensaje,
                    delay: 3000
                });
            } else if (tipoMensaje === "error") {
                PNotify.error({
                    title: 'Error',
                    text: mensaje,
                    delay: 3000
                });
            }
        </script>
    }

    <div class="container-fluid p-3 rounded shadow-sm bg-white">
        <div class="row align-items-center">
            <div class="col-md-6 text-start">
                <h1 class="m-0 text-uppercase fs-4">Gestionar Historia Clínica</h1>
            </div>

            <div class="col-md-6 text-end">
                <div class="btn-group" role="group" aria-label="Opciones de visita">
                    <a href="/Agenda" class="btn text-white" style="background-color: #00826F;">Volver</a>
                    <button class="btn text-white" style="background-color: #00826F;">Finalizar visita y salir</button>
                    <button class="btn text-white" style="background-color: #00826F;">Finalizar visita y facturar</button>
                </div>
            </div>
        </div>
    </div>


    <div class="container-fluid">
        <br />
        <div class="row">
            <div class="col-md-4">
                <div class="card shadow-sm">
                    <div class="card-header" style="background-color: #00826F; border: none;">
                        <h5 class="card-title text-white mb-0">Información del paciente</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <p><strong>ID:</strong> @($"{paciente.Nombre?[0]}{DateTime.Now:yyyyMMdd}{paciente.NumeroDocumento}")</p>
                                <img src="https://cdn.pixabay.com/photo/2015/10/05/22/37/blank-profile-picture-973460_1280.png" alt="Foto de perfil" class="img-fluid rounded" style="max-width: 180px; height: 180px;">
                            </div>
                            <div class="col-md-6">
                                <br /> <br /> <br />
                                <p><strong>Nombre:</strong> @($"{paciente.PrimerApellido?.ToUpper()}, {paciente.Nombre?.ToUpper()}")</p>
                                <p><strong>Email:</strong> @paciente.Email</p>
                                <p><strong>Telefono:</strong> @paciente.Telefono</p>
                                <p>
                                    <strong>Edad:</strong>
                                    @if (paciente.FechaNacimiento.HasValue)
                                    {
                                        <text>@(DateTime.Today.Year - paciente.FechaNacimiento.Value.Year) años</text>
                                    }
                                    else
                                    {
                                        <text>No especificada</text>
                                    }
                                </p>
                                <p><strong>Documento:</strong> @paciente.NumeroDocumento</p>
                            </div>
                        </div>
                        <div class="mt-3">
                            <div class="row">
                                <div class="col-12 mb-2">
                                    <button class="btn btn-success btn-sm w-100" style="background-color: #00826F; border: none;">Episodios</button>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-6 mb-2">
                                    <button class="btn btn-success btn-sm w-100" style="background-color: #00826F; border: none;">Imágenes y Documentos</button>
                                </div>
                                <div class="col-6 mb-2">
                                    <button class="btn btn-success btn-sm w-100" style="background-color: #00826F; border: none;">Agregar Antecedentes</button>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-12 mb-2">
                                    <button class="btn btn-success btn-sm w-100" style="background-color: #00826F; border: none;">Exportar</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card shadow-sm mt-3 ">
                    <div class="card-header" style="background-color: #00826F; border: none;">
                        <h5 class="card-title text-white mb-0">Antecedentes </h5>
                    </div>
                    <div class="card-body">
                        <!-- Enfermedad actual -->
                        <div class="mb-3">
                            @foreach (var historia in ViewBag.HistoriasClinicas)
                            {
                                <!-- Enfermedad Base -->
                                <div class="mb-3">
                                    <p>
                                        <strong class="text-center text-uppercase">@historia.EnfermedadBase</strong>
                                    </p>
                                </div>
                            }
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-8">
                <div class="container overflow-hidden">
                    <!-- Botones de historia clinica -->
                    <div class="row gx-5 rounded mb-4">
                        <div class="col-md-6">
                            <div class="rounded">
                                <div class="d-grid">
                                    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#exampleModal"
                                            style="background-color: #00826F; border: none; box-shadow: 0 2px 4px rgba(0,0,0,0.1);"
                                    @(ViewBag.HistoriasClinicas == null || ViewBag.HistoriasClinicas.Count == 0 ? "disabled" : "")
                                            title="@(ViewBag.HistoriasClinicas == null || ViewBag.HistoriasClinicas.Count == 0 ? "Primero debe registrar una historia clínica" : "")">
                                        <i class="ri-add-line"></i>  Registrar Visita Sucesiva
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="rounded">
                                <div class="d-grid">
                                    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#historiaClinicaModal" style="background-color: #00826F; border: none; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                        <i class="ri-hospital-fill"></i> Registrar Historia Clínica
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-12">
                            <!-- Modal Registro de Historia Clínica-->
                            <div class="modal fade" id="historiaClinicaModal" tabindex="-1" aria-labelledby="historiaClinicaModalLabel" aria-hidden="true">
                                <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
                                    <div class="modal-content">
                                        <div class="modal-header">
                                            <h5 class="modal-title" id="historiaClinicaModalLabel">Registro de Historia Clínica</h5>
                                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                        </div>
                                        <div class="modal-body">
                                            <!-- Formulario de Historia Clínica -->
                                            <form id="historiaClinicaForm" asp-action="Create" asp-route-citaId="@ViewBag.CitaId">
                                                <!-- Motivo de consulta -->
                                                <div class="form-group mb-3">
                                                    <label asp-for="MotivoConsulta"><strong>Motivo de consulta</strong></label>
                                                    <textarea class="form-control" asp-for="MotivoConsulta" rows="3" required></textarea>
                                                    <span asp-validation-for="MotivoConsulta" class="text-danger"></span>
                                                </div>

                                                <!-- Enfermedad actual -->
                                                <div class="form-group mb-3">
                                                    <label asp-for="EnfermedadActual"><strong>Enfermedad actual</strong></label>
                                                    <textarea class="form-control" asp-for="EnfermedadActual" rows="3" required></textarea>
                                                    <span asp-validation-for="EnfermedadActual" class="text-danger"></span>
                                                </div>
                                                <!-- Enfermedad Base -->
                                                <div class="form-group mb-3">
                                                    <label asp-for="EnfermedadBase"><strong>Antecedentes</strong></label>
                                                    <input class="form-control" asp-for="EnfermedadBase">
                                                </div>

                                                
                                                <!-- Examen físico -->
                                                <div class="form-group mb-3">
                                                    <label><strong>Examen físico</strong></label>

                                                    <div class="row">
                                                        <div class="col-md-4 mb-2">
                                                            <label asp-for="Temperatura">Temperatura</label>
                                                            <input type="text" class="form-control" asp-for="Temperatura" placeholder="°C">
                                                        </div>
                                                        <div class="col-md-4 mb-2">
                                                            <label asp-for="FrecuenciaCardiaca">Frecuencia cardiaca</label>
                                                            <input type="text" class="form-control" asp-for="FrecuenciaCardiaca" placeholder="lpm">
                                                        </div>
                                                        <div class="col-md-4 mb-2">
                                                            <label asp-for="TensionArterial">Tensión arterial</label>
                                                            <input type="text" class="form-control" asp-for="TensionArterial" placeholder="mmHg">
                                                        </div>
                                                       
                                                    </div>

                                                    <div class="row mt-2">
                                                        <div class="col-md-4 mb-2">
                                                            <label asp-for="FrecuenciaRespiratoria">Frecuencia respiratoria</label>
                                                            <input type="text" class="form-control" asp-for="FrecuenciaRespiratoria" placeholder="rpm">
                                                        </div>
                                                        <div class="col-md-4 mb-2">
                                                            <label asp-for="SatO2">Sat O2</label>
                                                            <input type="text" class="form-control" asp-for="SatO2" placeholder="%">
                                                        </div>
                                                    </div>
                                                    <!-- Observaciones fisicas -->
                                                    <div class="form-group mb-3">
                                                        <label asp-for="ObservacionesExamenFisico"><strong>Observaciones Examen Fisico</strong></label>
                                                        <textarea class="form-control" asp-for="ObservacionesExamenFisico"></textarea>
                                                    </div>
                                                </div>

                                                <!-- Diagnóstico -->
                                                <div class="form-group mb-3">
                                                    <label asp-for="Diagnostico"><strong>Diagnóstico</strong></label>
                                                    <textarea class="form-control" asp-for="Diagnostico" rows="3" required></textarea>
                                                    <span asp-validation-for="Diagnostico" class="text-danger"></span>
                                                </div>

                                                <!-- Evolución / Análisis -->
                                                <div class="form-group mb-3">
                                                    <label asp-for="EvolucionAnalisis"><strong>Evolución / Análisis</strong></label>
                                                    <textarea class="form-control" asp-for="EvolucionAnalisis" rows="3" required></textarea>
                                                    <span asp-validation-for="EvolucionAnalisis" class="text-danger"></span>
                                                </div>

                                                <!-- Conducta médica y recomendaciones -->
                                                <div class="form-group mb-3">
                                                    <label asp-for="ConductaMedica"><strong>Conducta médica y recomendaciones</strong></label>
                                                    <textarea class="form-control" asp-for="ConductaMedica" rows="3" required></textarea>
                                                    <span asp-validation-for="ConductaMedica" class="text-danger"></span>
                                                </div>
                                                <div class="form-group mb-3">
                                                    <label for="IdMedico">Profesional responsable</label>
                                                    <select class="form-select" id="IdMedico" name="IdMedico" required>
                                                        <option value="">Seleccione un profesional</option>
                                                        @foreach (var doctor in ViewBag.Doctores)
                                                        {
                                                            <option value="@doctor.Value">@doctor.Text</option>
                                                        }
                                                    </select>
                                                </div>
                                                <!-- Procedimientos profesionales - VERSIÓN CORREGIDA -->
                                                <div class="form-group mb-3">
                                                    <div id="procedimientos-container">
                                                        <label><strong>Procedimientos profesionales</strong></label>
                                                        <!-- Procedimiento inicial -->
                                                        <div class="procedimiento-item mb-4 border p-3 rounded" data-index="0">
                                                            <div class="form-group mb-2">
                                                                <label for="NombreProcedimiento_0">Nombre del procedimiento</label>
                                                                <input type="text" class="form-control"
                                                                       id="NombreProcedimiento_0"
                                                                       name="Procedimientos[0].NombreProcedimiento"
                                                                       placeholder="Ej: Consulta general, Cirugía menor, etc.">
                                                                <span class="text-danger field-validation-valid"
                                                                      data-valmsg-for="Procedimientos[0].NombreProcedimiento"
                                                                      data-valmsg-replace="true"></span>
                                                            </div>

                                                            <div class="form-group mb-2">
                                                                <label for="Observaciones_0">Observaciones</label>
                                                                <textarea class="form-control"
                                                                          id="Observaciones_0"
                                                                          name="Procedimientos[0].Observaciones"
                                                                          rows="2"></textarea>
                                                                <span class="text-danger field-validation-valid"
                                                                      data-valmsg-for="Procedimientos[0].Observaciones"
                                                                      data-valmsg-replace="true"></span>
                                                            </div>

                                                            <div class="row">
                                                                <div class="col-md-6 mb-2">
                                                                    <label for="FechaProcedimiento_0">Fecha del procedimiento</label>
                                                                    <input type="date" class="form-control"
                                                                           id="FechaProcedimiento_0"
                                                                           name="Procedimientos[0].FechaProcedimiento"
                                                                           value="@DateTime.Now.ToString("yyyy-MM-dd")">
                                                                    <span class="text-danger field-validation-valid"
                                                                          data-valmsg-for="Procedimientos[0].FechaProcedimiento"
                                                                          data-valmsg-replace="true"></span>
                                                                </div>
                                                                <div class="col-md-6 mb-2">
                                                                    <label for="IdMedico">Médico responsable</label>
                                                                    <select class="form-select"
                                                                            id="IdMedico"name="Procedimientos[0].IdMedico" required>
                                                                        <option value="">Seleccione un médico</option>
                                                                        @foreach (var doctor in ViewBag.Doctores)
                                                                        {
                                                                            <option value="@doctor.Value">@doctor.Text</option>
                                                                        }
                                                                    </select>
                                                                    <span class="text-danger field-validation-valid"
                                                                          data-valmsg-for="Procedimientos[0].IdMedico"
                                                                          data-valmsg-replace="true"></span>
                                                                </div>
                                                            </div>

                                                            <button type="button" class="btn btn-sm btn-danger remove-procedimiento float-end" style="display: none;">
                                                                <i class="fas fa-trash"></i> Eliminar
                                                            </button>
                                                            <div class="clearfix"></div>
                                                        </div>
                                                    </div>
                                                </div>

                                                <!-- Botones de acción -->
                                                <div class="modal-footer">
                                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                                                    <button type="button" id="agregar-procedimiento" class="btn btn-success" style="background-color: #00826F; border: none;">
                                                        <i class="fas fa-plus"></i> Agregar procedimiento
                                                    </button>

                                                    <button type="submit" class="btn btn-success" style="background-color: #00826F; border: none;">
                                                        <i class="fas fa-save me-2"></i> Guardar Historia Clínica
                                                    </button>
                                                </div>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- Modal Visita Sucesiva-->
                            <div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
                                <div class="modal-dialog modal-lg">
                                    <div class="modal-content">
                                        <div class="modal-header p-2" style="background-color: #00826F; border: none;">
                                            <h5 class="modal-title" id="exampleModalLabel">Visita Sucesiva</h5>
                                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                        </div>
                                        <div class="modal-body">
                                            <form id="evolucionForm" asp-action="InsertarVisitaSucesiva" method="post">
                                                <input type="hidden" asp-for="IdHistoriaClinica" value="@ViewBag.IdHistoriaClinica" />
                                                <input type="hidden" asp-for="IdCita" value="@ViewBag.CitaId" />

                                                <!-- 1. Evolución / Análisis -->
                                                <div class="mb-4">
                                                    <label asp-for="EvolucionAnalisis" class="form-label fw-bold">1. Evolución / Análisis</label>
                                                    <textarea class="form-control" asp-for="EvolucionAnalisis" rows="4" required></textarea>
                                                    <span asp-validation-for="EvolucionAnalisis" class="text-danger"></span>
                                                </div>

                                                <!-- 2. Conducta médica y recomendaciones -->
                                                <div class="mb-4">
                                                    <label asp-for="ConductaMedica" class="form-label fw-bold">2. Conducta médica y recomendaciones</label>
                                                    <textarea class="form-control" asp-for="ConductaMedica" rows="4" required></textarea>
                                                    <span asp-validation-for="ConductaMedica" class="text-danger"></span>
                                                </div>

                                                <!-- 3. Procedimientos profesionales -->
                                                <div class="mb-4">
                                                    <h5 class="fw-bold mb-3">3. Procedimientos profesionales</h5>
                                                    <div id="VS-procedimientos-container">
                                                        <!-- Procedimiento inicial -->
                                                        <div class="card w-100 mb-3 VS-procedimiento-item" data-index="0">
                                                            <div class="card-header bg-light fw-bold d-flex justify-content-between align-items-center">
                                                                <span>Procedimiento 1</span>
                                                                <button type="button" class="btn btn-sm btn-danger VS-remove-procedimiento" style="display: none;">Eliminar</button>
                                                            </div>
                                                            <div class="card-body">
                                                                <div class="mb-3">
                                                                    <label class="form-label">a. Fecha del procedimiento</label>
                                                                    <input type="date" class="form-control"
                                                                           id="VS-FechaProcedimiento_0"
                                                                           name="Procedimientos[0].FechaProcedimiento"
                                                                           value="@DateTime.Now.ToString("yyyy-MM-dd")">
                                                                    <span class="text-danger field-validation-valid"
                                                                          data-valmsg-for="Procedimientos[0].FechaProcedimiento"
                                                                          data-valmsg-replace="true"></span>
                                                                </div>
                                                                <div class="mb-3">
                                                                    <label class="form-label">b. Observación</label>
                                                                    <textarea class="form-control"
                                                                              id="VS-Observaciones_0"
                                                                              name="Procedimientos[0].Observaciones"
                                                                              rows="3"></textarea>
                                                                    <span class="text-danger field-validation-valid"
                                                                          data-valmsg-for="Procedimientos[0].Observaciones"
                                                                          data-valmsg-replace="true"></span>
                                                                </div>
                                                                <div class="mb-3">
                                                                    <label class="form-label">c. Nombre del profesional</label>
                                                                    <select class="form-select"
                                                                            id="VS-IdMedico_0"
                                                                            name="Procedimientos[0].IdProfesional" required>
                                                                        <option selected disabled value="">Seleccione un doctor</option>
                                                                        @if (ViewBag.Doctores != null)
                                                                        {
                                                                            @foreach (var doctor in ViewBag.Doctores)
                                                                            {
                                                                                <option value="@doctor.Value">@doctor.Text</option>
                                                                            }
                                                                        }
                                                                        else
                                                                        {
                                                                            <option disabled>No hay doctores disponibles</option>
                                                                        }
                                                                    </select>
                                                                    <span class="text-danger field-validation-valid"
                                                                          data-valmsg-for="Procedimientos[0].IdProfesional"
                                                                          data-valmsg-replace="true"></span>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>

                                                <div class="modal-footer">
                                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                                                    <button type="button" id="VS-agregar-procedimiento" class="btn btn-success" style="background-color: #00826F; border: none;">
                                                        <i class="fas fa-plus me-2"></i>Agregar procedimiento
                                                    </button>

                                                    <button type="submit" class="btn btn-primary" style="background-color: #00826F; border: none;">Guardar Visita</button>
                                                </div>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- Sección de visitas anteriores -->
                            @if (ViewBag.HistoriasClinicas != null && ViewBag.HistoriasClinicas.Count > 0)
                            {
                                @foreach (var historia in ViewBag.HistoriasClinicas)
                                {
                                    <div class="details">
                                        <details class="card border-success mb-3">
                                            <summary class="card-header text-white summary" style="background-color: #00826F; border: none;">
                                                @{
                                                    var fechaTexto = historia.FechaAlta != null ?
                                                    Convert.ToDateTime(historia.FechaAlta).ToString("dd/MM/yyyy") :
                                                    "Fecha no disponible";

                                                    var primerProc = historia.Procedimientos.Count > 0 ? historia.Procedimientos[0] : null;
                                                    var procedimientoTexto = primerProc != null ? primerProc.NombreProcedimiento : "Sin procedimiento";
                                                }
                                                Visita @fechaTexto - @procedimientoTexto
                                            </summary>
                                            <div class="card-body content">
                                                <h4 style="background-color: #00826F; border: none;" class="p-2 text-white rounded text-center">Historia Clínica</h4>

                                                <!-- Motivo de consulta -->
                                                <div class="mb-3">
                                                    <h5><strong>Motivo de Consulta:</strong></h5>
                                                    <p>@historia.MotivoConsulta</p>
                                                </div>

                                                <!-- Enfermedad actual -->
                                                <div class="mb-3">
                                                    <h5><strong>Enfermedad Actual:</strong></h5>
                                                    <p>@historia.EnfermedadActual</p>
                                                </div>

                                                <!-- Examen físico -->
                                                <div class="mb-3">
                                                    <h5><strong>Examen Físico:</strong></h5>
                                                    @if (historia.ExamenFisico != null)
                                                    {
                                                        <div class="row">
                                                            <div class="col-md-4">
                                                                <p><strong>Temperatura:</strong> @historia.ExamenFisico.Temperatura</p>
                                                            </div>
                                                            <div class="col-md-4">
                                                                <p><strong>Frecuencia Cardíaca:</strong> @historia.ExamenFisico.FrecuenciaCardiaca</p>
                                                            </div>
                                                            <div class="col-md-4">
                                                                <p><strong>Tensión Arterial:</strong> @historia.ExamenFisico.TensionArterial</p>
                                                            </div>
                                                        </div>
                                                        <div class="row">
                                                            <div class="col-md-4">
                                                                <p><strong>Frecuencia Respiratoria:</strong> @historia.ExamenFisico.FrecuenciaRespiratoria</p>
                                                            </div>
                                                            <div class="col-md-4">
                                                                <p><strong>Sat O2:</strong> @historia.ExamenFisico.SatO2</p>
                                                            </div>
                                                        </div>
                                                    }
                                                    else
                                                    {
                                                        <p>No se registró examen físico</p>
                                                    }
                                                </div>

                                                <!-- Diagnóstico -->
                                                <div class="mb-3">
                                                    <h5><strong>Diagnóstico:</strong></h5>
                                                    <p>@historia.Diagnostico</p>
                                                </div>

                                                <!-- Evolución / Análisis -->
                                                <div class="mb-3">
                                                    <h5><strong>Evolución / Análisis:</strong></h5>
                                                    <p>@historia.EvolucionAnalisis</p>
                                                </div>

                                                <!-- Conducta médica -->
                                                <div class="mb-3">
                                                    <h5><strong>Conducta Médica y Recomendaciones:</strong></h5>
                                                    <p>@historia.ConductaMedicaRecomendaciones</p>
                                                </div>

                                                <!-- Procedimientos -->
                                                <div class="mb-3">
                                                    <h5><strong>Procedimientos:</strong></h5>
                                                    @if (historia.Procedimientos != null && historia.Procedimientos.Count > 0)
                                                    {
                                                        <table class="table table-bordered ">
                                                            <thead class="bg-dark text-white">
                                                                <tr>
                                                                    <th>Nombre</th>
                                                                    <th>Fecha</th>
                                                                    <th>Profesional</th>
                                                                    <th>Observaciones</th>
                                                                </tr>
                                                            </thead>
                                                            <tbody>
                                                                @foreach (var procedimiento in historia.Procedimientos)
                                                                {
                                                                    <tr>
                                                                        <td>@procedimiento.NombreProcedimiento</td>
                                                                        <td>@(procedimiento.FechaProcedimiento?.ToString("dd/MM/yyyy") ?? "No especificada")</td>
                                                                        <td>@procedimiento.NombreProfesional</td>
                                                                        <td>@procedimiento.Observaciones</td>
                                                                    </tr>
                                                                }
                                                            </tbody>
                                                        </table>
                                                    }
                                                    else
                                                    {
                                                        <p>No hay procedimientos registrados</p>
                                                    }
                                                </div>

                                                <!-- Visitas sucesivas (se mantiene igual que antes) -->
                                                @if (historia.VisitasSucesivas != null && historia.VisitasSucesivas.Count > 0)
                                                {
                                                    <div class="mt-4">
                                                        <h4 style="background-color: #00826F; border: none;" class="p-2 text-white rounded text-center">Visitas Sucesivas</h4>

                                                        @foreach (var visita in historia.VisitasSucesivas)
                                                        {
                                                            <details class="card border-success mb-3">
                                                                <summary class="card-header text-white" style="background-color: #00826F; border: none;">
                                                                    Visita del @visita.FechaVisita.ToString("dd/MM/yyyy HH:mm") -
                                                                    Médico: @visita.MedicoResponsable
                                                                </summary>
                                                                <div class="card-body">
                                                                    <div class="row">
                                                                        <div class="col-md-6">
                                                                            <h6>Evolución / Análisis:</h6>
                                                                            <p>@visita.EvolucionAnalisis</p>
                                                                        </div>
                                                                        <div class="col-md-6">
                                                                            <h6>Conducta médica:</h6>
                                                                            <p>@visita.ConductaMedica</p>
                                                                        </div>
                                                                    </div>

                                                                    @if (visita.Procedimientos != null && visita.Procedimientos.Count > 0)
                                                                    {
                                                                        <div class="mt-3">
                                                                            <h5>Procedimientos realizados:</h5>
                                                                            @foreach (var proc in visita.Procedimientos)
                                                                            {
                                                                                <div class="card mb-2">
                                                                                    <div class="card-body">
                                                                                        <p><strong>Fecha:</strong> @proc.FechaProcedimiento.ToString("dd/MM/yyyy")</p>
                                                                                        <p><strong>Profesional:</strong> @proc.Profesional</p>
                                                                                        <p><strong>Observaciones:</strong> @proc.Observaciones</p>
                                                                                    </div>
                                                                                </div>
                                                                            }
                                                                        </div>
                                                                    }
                                                                </div>
                                                            </details>
                                                        }
                                                    </div>
                                                }
                                            </div>
                                        </details>
                                    </div>
                                }
                            }
                            else
                            {
                                <div class="alert alert-info mt-4">
                                    No hay historias clínicas registradas para este paciente.
                                </div>
                            }
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    @section Scripts {
        <script>
            $(document).ready(function() {
    let VSProcedimientoIndex = 1;
    $('#VS-agregar-procedimiento').click(function() {
        const newIndex = VSProcedimientoIndex++;
        const newProcedimiento = $(`
            <div class="card w-100 mb-3 VS-procedimiento-item" data-index="${newIndex}">
                <div class="card-header bg-light fw-bold d-flex justify-content-between align-items-center">
                    <span>Procedimiento ${newIndex + 1}</span>
                    <button type="button" class="btn btn-sm btn-danger VS-remove-procedimiento">Eliminar</button>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="form-label">a. Fecha del procedimiento</label>
                        <input type="date" class="form-control"
                                id="VS-FechaProcedimiento_${newIndex}"
                                name="Procedimientos[${newIndex}].FechaProcedimiento"
                                value="@DateTime.Now.ToString("yyyy-MM-dd")">
                        <span class="text-danger field-validation-valid"
                                data-valmsg-for="Procedimientos[${newIndex}].FechaProcedimiento"
                                data-valmsg-replace="true"></span>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">b. Observación</label>
                        <textarea class="form-control"
                                    id="VS-Observaciones_${newIndex}"
                                    name="Procedimientos[${newIndex}].Observaciones"
                                    rows="3"></textarea>
                        <span class="text-danger field-validation-valid"
                                data-valmsg-for="Procedimientos[${newIndex}].Observaciones"
                                data-valmsg-replace="true"></span>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">c. Nombre del profesional</label>
                        <select class="form-select"
                                id="VS-IdMedico_${newIndex}"
                                        name="Procedimientos[${newIndex}].IdProfesional" required>
                            <option selected disabled value="">Seleccione un doctor</option>
                            @if (ViewBag.Doctores != null)
                            {
                                @foreach (var doctor in ViewBag.Doctores)
                                {
                                    <option value="@doctor.Value">@doctor.Text</option>
                                }
                            }
                            else
                            {
                                    <option disabled>No hay doctores disponibles</option>
                            }
                        </select>
                        <span class="text-danger field-validation-valid"
                                        data-valmsg-for="Procedimientos[${newIndex}].IdProfesional"
                                data-valmsg-replace="true"></span>
                    </div>
                </div>
            </div>
        `);

        $('#VS-procedimientos-container').append(newProcedimiento);

        if (VSProcedimientoIndex > 1) {
            $('.VS-procedimiento-item:first .VS-remove-procedimiento').show();
        }
    });

    // Eliminar procedimiento en Visita Sucesiva
    $(document).on('click', '.VS-remove-procedimiento', function() {
        $(this).closest('.VS-procedimiento-item').remove();
        $('.VS-procedimiento-item').each(function(index) {
            $(this).attr('data-index', index);
            $(this).find('.card-header span').text(`Procedimiento ${index + 1}`);

            $(this).find('[name]').each(function() {
                const name = $(this).attr('name').replace(/\[\d+\]/, `[${index}]`);
                $(this).attr('name', name);
            });

            $(this).find('[id]').each(function() {
                const id = $(this).attr('id').replace(/_(\d+)/, `_${index}`);
                $(this).attr('id', id);
            });

            $(this).find('[data-valmsg-for]').each(function() {
                const valmsgFor = $(this).attr('data-valmsg-for').replace(/\[\d+\]/, `[${index}]`);
                $(this).attr('data-valmsg-for', valmsgFor);
            });
        });

        VSProcedimientoIndex = $('.VS-procedimiento-item').length;
        if (VSProcedimientoIndex === 1) {
            $('.VS-procedimiento-item:first .VS-remove-procedimiento').hide();
        }
    });
    });
            $(document).ready(function() {
                    let procedimientoIndex = 1;

                    $('#agregar-procedimiento').click(function() {
                        const newIndex = procedimientoIndex++;
                        const newProcedimiento = $(`
                            <div class="procedimiento-item mb-4 border p-3 rounded" data-index="${newIndex}">
                                <div class="form-group mb-2">
                                    <label for="NombreProcedimiento_${newIndex}">Nombre del procedimiento</label>
                                    <input type="text" class="form-control"
                                           id="NombreProcedimiento_${newIndex}"
                                           name="Procedimientos[${newIndex}].NombreProcedimiento"
                                           placeholder="Ej: Consulta general, Cirugía menor, etc.">
                                    <span class="text-danger field-validation-valid"
                                          data-valmsg-for="Procedimientos[${newIndex}].NombreProcedimiento"
                                          data-valmsg-replace="true"></span>
                                </div>

                                <div class="form-group mb-2">
                                    <label for="Observaciones_${newIndex}">Observaciones</label>
                                    <textarea class="form-control"
                                              id="Observaciones_${newIndex}"
                                              name="Procedimientos[${newIndex}].Observaciones"
                                              rows="2"></textarea>
                                    <span class="text-danger field-validation-valid"
                                          data-valmsg-for="Procedimientos[${newIndex}].Observaciones"
                                          data-valmsg-replace="true"></span>
                                </div>

                                <div class="row">
                                    <div class="col-md-6 mb-2">
                                        <label for="FechaProcedimiento_${newIndex}">Fecha del procedimiento</label>
                                        <input type="date" class="form-control"
                                               id="FechaProcedimiento_${newIndex}"
                                               name="Procedimientos[${newIndex}].FechaProcedimiento"
                                               value="@DateTime.Now.ToString("yyyy-MM-dd")">
                                        <span class="text-danger field-validation-valid"
                                              data-valmsg-for="Procedimientos[${newIndex}].FechaProcedimiento"
                                              data-valmsg-replace="true"></span>
                                    </div>
                                    <div class="col-md-6 mb-2">
                                        <label for="IdMedico_${newIndex}">Médico responsable</label>
                                        <select class="form-select"
                                                id="IdMedico_${newIndex}" name="Procedimientos[${newIndex}].IdMedico" required>
                                            <option value="">Seleccione un médico</option>
                                            @foreach (var doctor in ViewBag.Doctores)
                                            {
                                                <option value="@doctor.Value">@doctor.Text</option>
                                            }
                                        </select>
                                        <span class="text-danger field-validation-valid"
                                              data-valmsg-for="Procedimientos[${newIndex}].IdMedico"
                                              data-valmsg-replace="true"></span>
                                    </div>
                                </div>

                                <button type="button" class="btn btn-sm btn-danger remove-procedimiento float-end">
                                    <i class="fas fa-trash"></i> Eliminar
                                </button>
                                <div class="clearfix"></div>
                            </div>
                        `);

                        $('#procedimientos-container').append(newProcedimiento);
                        if (procedimientoIndex > 1) {
                            $('.procedimiento-item:first .remove-procedimiento').show();
                        }
                    });

                    // Eliminar procedimiento
                    $(document).on('click', '.remove-procedimiento', function() {
                        $(this).closest('.procedimiento-item').remove();

                        $('.procedimiento-item').each(function(index) {
                            $(this).attr('data-index', index);

                            $(this).find('[name]').each(function() {
                                const name = $(this).attr('name').replace(/\[\d+\]/, `[${index}]`);
                                $(this).attr('name', name);
                            });

                            $(this).find('[id]').each(function() {
                                const id = $(this).attr('id').replace(/_(\d+)/, `_${index}`);
                                $(this).attr('id', id);
                            });

                            $(this).find('[data-valmsg-for]').each(function() {
                                const valmsgFor = $(this).attr('data-valmsg-for').replace(/\[\d+\]/, `[${index}]`);
                                $(this).attr('data-valmsg-for', valmsgFor);
                            });
                        });

                        procedimientoIndex = $('.procedimiento-item').length;

                        if (procedimientoIndex === 1) {
                            $('.procedimiento-item:first .remove-procedimiento').hide();
                        }
                    });
                });
                //EXPORTAR PDF
                                       function exportToPDF() {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();

                // Configuración inicial
                doc.setFont('helvetica');
                let yPosition = 20;
                const pageWidth = doc.internal.pageSize.getWidth();
                const margin = 15;
                const lineHeight = 7;
                const maxY = doc.internal.pageSize.getHeight() - 20;

                // Estilos reutilizables
                const styles = {
                    title: { size: 18, color: [0, 130, 111], align: 'center' },
                    subtitle: { size: 14, color: [0, 130, 111], bold: true },
                    sectionTitle: { size: 11, color: [0, 130, 111], bold: true },
                    bodyText: { size: 10, color: [0, 0, 0] },
                    smallText: { size: 8, color: [100, 100, 100] }
                };

                // Función para aplicar estilos
                const applyStyle = (style) => {
                    doc.setFontSize(style.size);
                    doc.setTextColor(...style.color);
                    doc.setFont(undefined, style.bold ? 'bold' : 'normal');
                };

                // Función para agregar texto con manejo de saltos de página
                const addText = (text, x, y, options = {}) => {
                    if (y > maxY) {
                        doc.addPage();
                        y = 20;
                    }

                    const maxWidth = options.maxWidth || (pageWidth - 2 * margin);
                    const lines = doc.splitTextToSize(text, maxWidth);

                    doc.text(lines, x, y, options);
                    return y + (lines.length * lineHeight) + (options.extraSpace || 0);
                };

                // Título del documento
                applyStyle(styles.title);
                doc.text('HISTORIA CLÍNICA', pageWidth / 2, yPosition, { align: 'center' });
                yPosition += 12;

                // Línea decorativa
                doc.setDrawColor(0, 130, 111);
                doc.setLineWidth(0.8);
                doc.line(margin, yPosition, pageWidth - margin, yPosition);
                yPosition += 15;

                // Información del paciente en tabla
                const patientData = {
                    nombre: $('.card-body p:contains("Nombre:")').text().replace("Nombre:", "").trim(),
                    documento: $('.card-body p:contains("Documento:")').text().replace("Documento:", "").trim(),
                    email: $('.card-body p:contains("Email:")').text().replace("Email:", "").trim(),
                    telefono: $('.card-body p:contains("Teléfono:")').text().replace("Teléfono:", "").trim(),
                    fechaNacimiento: $('.card-body p:contains("Fecha Nacimiento:")').text().replace("Fecha Nacimiento:", "").trim() || 'No especificada'
                };

                // Tabla de información del paciente
                applyStyle(styles.subtitle);
                doc.text('INFORMACIÓN DEL PACIENTE', margin, yPosition);
                yPosition += 10;

                doc.autoTable({
                    startY: yPosition,
                    head: [['Campo', 'Valor']],
                    body: [
                        ['Nombre completo', patientData.nombre],
                        ['Documento', patientData.documento],
                        ['Email', patientData.email],
                        ['Teléfono', patientData.telefono],
                        ['Fecha de nacimiento', patientData.fechaNacimiento]
                    ],
                    margin: { left: margin, right: margin },
                    styles: {
                        fontSize: 10,
                        cellPadding: 4,
                        valign: 'middle'
                    },
                    headStyles: {
                        fillColor: [0, 130, 111],
                        textColor: 255,
                        fontStyle: 'bold'
                    },
                    alternateRowStyles: {
                        fillColor: [240, 240, 240]
                    },
                    columnStyles: {
                        0: { fontStyle: 'bold', cellWidth: 50 }
                    },
                    theme: 'grid'
                });

                yPosition = doc.lastAutoTable.finalY + 15;

                // Procesar cada visita médica
                $('.details details').each(function(index) {
                    if (yPosition > maxY - 50) {
                        doc.addPage();
                        yPosition = 20;
                    }

                    const content = $(this).find('.content');

                    // Procesar secciones de la visita principal
                    const sections = content.find('div.mb-3');
                    if (sections.length > 0) {
                        sections.each(function() {
                            const title = $(this).find('h5 strong').text().replace(':', '').trim();
                            const text = $(this).find('p').text().trim();

                            if (title && text) {
                                applyStyle(styles.sectionTitle);
                                doc.text(`${title}:`, margin, yPosition);

                                doc.setDrawColor(200, 200, 200);
                                doc.setLineWidth(0.2);
                                doc.line(margin, yPosition + 1.5, margin + 30, yPosition + 1.5);

                                yPosition += lineHeight;

                                applyStyle(styles.bodyText);
                                yPosition = addText(text, margin + 5, yPosition, { maxWidth: pageWidth - 2 * margin - 5 }) + 5;
                            }
                        });
                    }

                    // Procesar procedimientos de la visita principal
                    const procedimientosTable = content.find('table');
                    if (procedimientosTable.length > 0) {
                        applyStyle(styles.sectionTitle);
                        yPosition = addText('PROCEDIMIENTOS REALIZADOS:', margin, yPosition) + 3;

                        const headers = ["Nombre", "Fecha", "Profesional", "Observaciones"];
                        const rows = [];

                        procedimientosTable.find('tbody tr').each(function() {
                            const row = [];
                            $(this).find('td').each(function() {
                                row.push($(this).text().trim());
                            });
                            rows.push(row);
                        });

                        doc.autoTable({
                            startY: yPosition,
                            head: [headers],
                            body: rows,
                            margin: { left: margin, right: margin },
                            styles: {
                                fontSize: 8,
                                cellPadding: 3,
                                overflow: 'linebreak'
                            },
                            headStyles: {
                                fillColor: [0, 130, 111],
                                textColor: 255,
                                fontSize: 9
                            },
                            alternateRowStyles: {
                                fillColor: [245, 245, 245]
                            },
                            columnStyles: {
                                0: { cellWidth: 40 },
                                1: { cellWidth: 25 },
                                2: { cellWidth: 35 },
                                3: { cellWidth: 'auto' }
                            }
                        });

                        yPosition = doc.lastAutoTable.finalY + 12;
                    }

                    // Procesar visitas sucesivas - Primero creamos una tabla resumen
                    const visitasSucesivas = content.find('details.card');
                    if (visitasSucesivas.length > 0) {
                        // Tabla resumen de visitas sucesivas
                        applyStyle(styles.sectionTitle);
                        doc.text('RESUMEN DE VISITAS SUCESIVAS', margin, yPosition);
                        yPosition += 10;

                        // Preparar datos para la tabla resumen
                        const resumenVisitas = [];

                        visitasSucesivas.each(function() {
                            const visitaSummary = $(this).find('summary').text().trim();
                            const visitaContent = $(this).find('.card-body');

                            // Extraer información básica de cada visita
                            const visitaSections = visitaContent.find('div.row:first-child');
                            const evolucion = visitaSections.find('h6:contains("Evolución")').parent().find('p').text().trim().substring(0, 50) + '...';
                            const procedimientosCount = visitaContent.find('.card.mb-2').length;

                            resumenVisitas.push([
                                visitaSummary,
                                evolucion,
                                procedimientosCount > 0 ? `${procedimientosCount} procedimiento(s)` : 'Sin procedimientos'
                            ]);
                        });

                        // Tabla resumen
                        doc.autoTable({
                            startY: yPosition,
                            head: [['Fecha Visita', 'Resumen Evolución', 'Procedimientos']],
                            body: resumenVisitas,
                            margin: { left: margin, right: margin },
                            styles: {
                                fontSize: 9,
                                cellPadding: 3,
                                overflow: 'linebreak'
                            },
                            headStyles: {
                                fillColor: [0, 100, 80],
                                textColor: 255,
                                fontSize: 9
                            },
                            alternateRowStyles: {
                                fillColor: [245, 245, 245]
                            },
                            columnStyles: {
                                0: { cellWidth: 30 },
                                1: { cellWidth: 'auto' },
                                2: { cellWidth: 30 }
                            }
                        });

                        yPosition = doc.lastAutoTable.finalY + 15;

                        // Detalle completo de cada visita sucesiva
                        applyStyle(styles.sectionTitle);
                        doc.text('DETALLE DE VISITAS SUCESIVAS', margin, yPosition);
                        yPosition += 10;

                        visitasSucesivas.each(function() {
                            const visitaSummary = $(this).find('summary').text().trim();
                            const visitaContent = $(this).find('.card-body');

                            // Encabezado de visita con estilo
                            applyStyle({ ...styles.sectionTitle, size: 12 });
                            doc.setFillColor(230, 244, 242);
                            doc.rect(margin, yPosition - 3, pageWidth - 2 * margin, 8, 'F');
                            doc.text(visitaSummary, margin + 5, yPosition);
                            yPosition += 10;

                            // Contenido de la visita
                            const visitaSections = visitaContent.find('div.row:first-child');
                            if (visitaSections.length > 0) {
                                // Evolución/Análisis
                                const evolucion = visitaSections.find('h6:contains("Evolución")').parent().find('p').text().trim();
                                if (evolucion) {
                                    applyStyle({ ...styles.bodyText, bold: true });
                                    yPosition = addText('Evolución/Análisis:', margin + 10, yPosition);

                                    applyStyle(styles.bodyText);
                                    yPosition = addText(evolucion, margin + 15, yPosition, { maxWidth: pageWidth - 2 * margin - 15 }) + 3;
                                }

                                // Conducta médica
                                const conducta = visitaSections.find('h6:contains("Conducta")').parent().find('p').text().trim();
                                if (conducta) {
                                    applyStyle({ ...styles.bodyText, bold: true });
                                    yPosition = addText('Conducta Médica:', margin + 10, yPosition);

                                    applyStyle(styles.bodyText);
                                    yPosition = addText(conducta, margin + 15, yPosition, { maxWidth: pageWidth - 2 * margin - 15 }) + 5;
                                }
                            }

                            // Procedimientos de visita sucesiva
                            const procedimientosVisita = visitaContent.find('.card.mb-2');
                            if (procedimientosVisita.length > 0) {
                                applyStyle({ ...styles.sectionTitle, size: 10 });
                                yPosition = addText('Procedimientos:', margin + 10, yPosition) + 2;

                                procedimientosVisita.each(function() {
                                    const fecha = $(this).find('p:contains("Fecha:")').text().replace("Fecha:", "").trim();
                                    const profesional = $(this).find('p:contains("Profesional:")').text().replace("Profesional:", "").trim();
                                    const observaciones = $(this).find('p:contains("Observaciones:")').text().replace("Observaciones:", "").trim();

                                    applyStyle({ ...styles.bodyText, size: 9, bold: true });
                                    yPosition = addText(`◦ ${fecha} - ${profesional}`, margin + 15, yPosition);

                                    if (observaciones) {
                                        applyStyle({ ...styles.bodyText, size: 9 });
                                        yPosition = addText(observaciones, margin + 20, yPosition, {
                                            maxWidth: pageWidth - 2 * margin - 20
                                        }) + 1;
                                    }

                                    yPosition += 3;
                                });
                            }

                            yPosition += 8;
                        });
                    }

                    yPosition += 15;
                });

                // Pie de página
                doc.setFontSize(styles.smallText.size);
                doc.setTextColor(...styles.smallText.color);
                doc.text(`Documento generado el ${new Date().toLocaleDateString('es-ES', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                })}`, pageWidth - margin, doc.internal.pageSize.getHeight() - 10, { align: 'right' });

                doc.setDrawColor(200, 200, 200);
                doc.setLineWidth(0.3);
                doc.line(margin, doc.internal.pageSize.getHeight() - 12, pageWidth - margin, doc.internal.pageSize.getHeight() - 12);

                // Guardar el PDF
                const formatDate = (date) => {
                    return date.toISOString().slice(0,10).split('-').reverse().join('-');
                };

                const fileName = `Historia_Clinica_${patientData.nombre.replace(/ /g, '_')}_${formatDate(new Date())}.pdf`;
                doc.save(fileName);
            }

            // Asignar la función al botón Exportar
            $(document).ready(function() {
                $('.btn-success:contains("Exportar")').click(exportToPDF);
            });
        </script>
    }
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>